# Autocheck
Автопроверки на схеме рабочего процесса
Чтобы выбрать подходящий момент для проверки среди этапов основного процесса — например, ETL, руководствуйтесь тремя принципами:
- Важно не нарушить логику основного процесса.
- Проверку нужно внедрить как можно раньше: это поможет быстрее и проще исправить недочёты.
- Для проверок на ссылочную целостность подходит не каждый момент. На некоторых этапах основного процесса — например, при обработке в staging-области, идентификаторы из одного файла могут ссылаться на данные, которые лежат в другом месте.
Разработка проверок

При проектировании автопроверок отталкивайтесь от их типа и своего ПО.
Определите глубину проверки:
- Проверки в файловой системе контролируют наличие файлов в папке, их количество, имена и размеры. Эти проверки простые, и их можно проводить с помощью команд операционной системы или удобных языков программирования.
- Проверки данных выявляют пропуски, значения NULL, проверяют ссылочную целостность. Разработать их можно на любом языке программирования, но лучше использовать языки запросов к БД, ведь они позволяют быстро обрабатывать большие данные.

Изучите IT-стратегию компании — список языков программирования и сред, которые можно использовать.
Так вам удастся выбрать оптимальный с точки зрения производительности всей системы способ запуска проверок. В учебном проекте вы разработали три проверки.

## Проверка № 1
Что проверяли: наличие нужных для импорта файлов
Как проверяли: с помощью инструмента Sensor в Airflow
Почему этот способ: сенсоры — это операторы, которые реагируют на событие. Например, появление файлов в папке. Опция Sensor есть в планировщике Airflow, в котором выстроен ваш ETL-процесс. Это идеальный вариант для вашей задачи.

## Проверка № 2
Что проверяли: импортируемые файлы на значение NULL
Как проверяли: с помощью SQLCheckOperator в Airflow
Почему этот способ: вторая проверка проходит на уровне данных. Поскольку вы работаете с Postgres, вам доступен SQL. SQLCheckOperator нужен, чтобы вызвать SQL-запрос из Airflow, где описан ваш ETL. Есть и другие операторы, но мы рекомендуем этот, потому что он вызывает SQL-запрос из внешнего файла — с этим оператором можно обойтись без больших изменений в коде ETL-процесса в Airflow. На практике подобные SQL-запросы часто объёмные. SQLCheckOperator очень выручает в работе с ними.

## Проверка № 3
Что проверяли: чтобы число клиентов в файлах для импорта было больше трёх
Как проверяли: с помощью SQLValueCheckOperator в Airflow
Почему этот способ: SQLValueCheckOperator сравнивает результат выполнения SQL-запроса с заданным значением, в чём и заключается проверка № 3. К тому же способность SQLCheckOperator вызывать запрос из внешнего файла для третьей проверки не важна, потому что запросы на подсчёт количества значений простые и их несложно прописать в коде основного процесса в Airflow.

## Таблица с результатами проверки
При настройке контроля качества данных не забудьте создать таблицу для хранения его результатов. Она позволяет анализировать работу проверок и вовремя замечать ошибки в процессах.
В таблице обычно хранится следующая информация:
- название проверяемого объекта (таблица, файл, представление или что-то другое);
- название проверки или ее кодовое обозначение;
- дата и время выполнения проверки;
- результат проверки: запись о том, прошли её данные или нет.

Чтобы результаты проверок сохранялись в таблицу, нужно дополнить код основного процесса. Вы использовали для этого функцию Callbacks в Airflow.
## Внедрение проверки в процесс
Чтобы встроить проверки в рабочий процесс, составьте план изменений. Опишите:
- Будущую схему всего процесса с новыми шагами;
- Вспомогательные действия — например, что вам нужно объединить старые шаги процесса в группу.
- Затем подготовьте новый скрипт основного процесса. Его можно собрать по частям.

## Отслеживание работы проверок
Когда проверки добавлены, остаётся только присматривать за их работой. В первую очередь это нужно на случай, если данные не пройдут критичную проверку и рабочий процесс остановится. Следить за процессом можно с помощью запросов к таблице с результатами проверок, а также автоматических оповещений.

## Зачем нужен Runbook
После внедрения проверок не забудьте задокументировать все изменения, которые реализовали в проекте. Это важно как для команды поддержки, так и для других инженеров данных, которые будут работать с вашим кодом.
Runbook процесса с проверкой должен содержать:
- Общую информацию о проверках,
- Описание изменений,
- Инструкцию по управлению процессом с проверкой,
- Список частых ошибок и способы их устранения.
